---
title: "jfc-test"
author: "justin creeden"
date: "5/14/2021"
output: html_document
---

# Header Start ---------------------------
# User: Justin Creeden / justincreeden@gmail.com
# Date created: 2021_05_14
# Script: 2021_05_14-JFC-test_run
# Purpose: This is a test run for creedenzymatic package
# Notes (if any): I used https://kalganem.github.io/creedenzymatic/articles/creedenzymatic.html as a tutorial
# 
# Important: This header is automatically generated when user creates new document. Listed user (Justin Creeden) is not nessesarily author/creator.
# Header End ---


Install required packages
```{r}
#install.packages("tidyverse")
#install.packages("devtools")
#devtools::install_github("kalganem/creedenzymatic")
#install.packages("ellipsis")
```


Load required libraries
```{r}
library(tidyverse)
library(devtools)
library(creedenzymatic)
```


Define variables
```{r}

####################### NH1: Females

#Location of KRSA's output "acrossChip_KRSA_FullTable" txt file
JFC_directory_krsa_input <- "input/nick/2021-05-22-nick-stk-ad_v_ctrl-females-KRSA-acrossChip_KRSA_FullTable_comp1.txt"

#Location of UKA's output "SummaryResults" txt file
JFC_directory_uka_input <- "input/nick/nick-stk-ad_v_ctrl-females_Summary UKA results 20210520-1453.txt"

#Project name
JFC_experiment_ID <- "NH1_stk_ad_v_ctrl-females-ce_combined"

#Desired location of Creedenzymatic output
JFC_directory_output <- "output/nick/"

#Select desired UKA metric
  #Mean Final Score
  JFC_desired_UKA_metric <- "Mean Final Score" 
  #Khaled, I changed this ^ from 'median' to 'mean'

  #Mean Kinase Statistic
  #JFC_desired_UKA_metric <- "Mean Kinase Statistic"
  

####################### NH2: Males

#Location of KRSA's output "acrossChip_KRSA_FullTable" txt file
#JFC_directory_krsa_input <- "input/nick/2021-05-22-nick-stk-ad_v_ctrl-males-KRSA-acrossChip_KRSA_FullTable_comp1.txt"

#Location of UKA's output "SummaryResults" txt file
#JFC_directory_uka_input <- "input/nick/nick-stk-ad_v_ctrl-males_Summary UKA results 20210520-1737.txt"

#Project name
#JFC_experiment_ID <- "NH2_stk_ad_v_ctrl-males-ce_combined"

#Desired location of Creedenzymatic output
#JFC_directory_output <- "output/nick/"

#Select desired UKA metric
  #Mean Final Score
  #JFC_desired_UKA_metric <- "Mean Final Score" 
  #Khaled, I changed this ^ from 'median' to 'mean'

  #Mean Kinase Statistic
  #JFC_desired_UKA_metric <- "Mean Kinase Statistic"


####################### NH3: Mixed (males and females)

#Location of KRSA's output "acrossChip_KRSA_FullTable" txt file
#JFC_directory_krsa_input <- "input/nick/2021-05-22-nick-stk-ad_v_ctrl-mixed-KRSA-acrossChip_KRSA_FullTable_comp1.txt"

#Location of UKA's output "SummaryResults" txt file
#JFC_directory_uka_input <- "input/nick/nick-stk-ad_v_ctrl-mixed_Summary UKA results 20210520-1811.txt"

#Project name
#JFC_experiment_ID <- "NH3_stk_ad_v_ctrl-mixed-ce_combined"

#Desired location of Creedenzymatic output
#JFC_directory_output <- "output/nick/"

#Select desired UKA metric
  #Mean Final Score
  #JFC_desired_UKA_metric <- "Mean Final Score" 
  #Khaled, I changed this ^ from 'median' to 'mean'

  #Mean Kinase Statistic
  #JFC_desired_UKA_metric <- "Mean Kinase Statistic"
  
  
  
```


Import and Reformat Input Data
```{r}

#Import KRSA
krsa_ex <- read_delim(JFC_directory_krsa_input, delim = "\t")
#Reformat KRSA
krsa_ex %>% select(Kinase, Z) %>% rename(Score = Z) -> krsa_ex

#Import UKA
uka_ex <- read_delim(JFC_directory_uka_input, delim = "\t")

#Reformat UKA
uka_ex %>% select("Kinase Name", JFC_desired_UKA_metric) %>% rename(Kinase = "Kinase Name", Score = JFC_desired_UKA_metric) -> uka_ex
```

Generate Creedenzymatic output and save
```{r}
# read and rank the KRSA table and use absolute values and descending sorting
read_krsa(krsa_ex, trns = "abs", sort = "desc") -> krsa_table_ranked
# read and rank the UKA table and use absolute values and descending sorting
read_uka(uka_ex, trns = "abs", sort = "desc") -> uka_table_ranked

# combine ranked tables
combine_tools(KRSA_df = krsa_table_ranked, UKA_df = uka_table_ranked) -> combined_df

# save file
write_delim(combined_df, paste0(JFC_directory_output, JFC_experiment_ID,"ce_combined_ranked_file.txt"), delim = "\t")

# filter out kinases found in quartile 1 or 2 either in KRSA or UKA and use the quartile_figure() for visualization
# added na.omit() to filter out NA values in found the Uniprot_Gene col
combined_df %>% filter(Qrt <= 1) %>% 
  pull(Uniprot_Gene) %>% 
  na.omit() %>% unique() -> sig_kinases

combined_df %>% filter(Uniprot_Gene %in% sig_kinases) %>% quartile_figure()

pdf(file = (paste0(JFC_directory_output,Sys.Date()," - ",JFC_experiment_ID," - ","creedenzymatic"," - ",".pdf")),useDingbats = F, width = 50 ,height = 3.5)
combined_df %>% filter(Uniprot_Gene %in% sig_kinases) %>% quartile_figure()
dev.off()

png(file = (paste0(JFC_directory_output,Sys.Date()," - ",JFC_experiment_ID," - ","creedenzymatic"," - ",".png")),width = 50000, height = 3500,units = "px",pointsize = 12,res = 1200)
combined_df %>% filter(Uniprot_Gene %in% sig_kinases) %>% quartile_figure()
dev.off()


# to fix this issue in the future, we need to update the master kinome mapping file
kinome_mp_file_v1 %>% 
  filter(KRSA %in% krsa_ex$Kinase) %>% distinct(KRSA) %>% pull(KRSA) -> krsa_kinases_mapped_inMasterFile

setdiff(krsa_ex$Kinase, krsa_kinases_mapped_inMasterFile) -> krsa_kinases_NOT_mapped_inMasterFile


kinome_mp_file_v1 %>% 
  filter(UKA %in% uka_ex$Kinase) %>% distinct(UKA) %>% pull(UKA) -> uka_kinases_mapped_inMasterFile

setdiff(uka_ex$Kinase, uka_kinases_mapped_inMasterFile) -> uka_kinases_NOT_mapped_inMasterFile

# number of kinases needed to mapped in master file
length(c(uka_kinases_NOT_mapped_inMasterFile, krsa_kinases_NOT_mapped_inMasterFile))

```

